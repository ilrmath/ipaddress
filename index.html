<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IPãƒ“ãƒƒãƒˆæ“ä½œãƒ©ãƒœ (NW/BC/é‡è¤‡è­¦å‘Šç‰ˆ)</title>
  <style>
    :root {
      --bg: #1a202c;
      --panel: #2d3748;
      --text: #e2e8f0;
      --accent: #63b3ed;
      --selected: #f6e05e;
      --error: #fc8181;
      --error-bg: #c53030;
      --warn-bg: #742a2a;
      --net1: #38b2ac;
      --net2: #ed8936;
      --mask: #a0aec0;
      --highlight: #d53f8c; /* Network Address Pink */
      --broadcast-orange: #ed8936;
      --broadcast-yellow: #f6e05e;
      --ip-color: #d6bcfa;   
      --ip-bg-on: #805ad5;   
      --success: #48bb78;
    }
    body {
      margin: 0; font-family: "Helvetica Neue", Arial, sans-serif;
      background: var(--bg); color: var(--text); padding: 15px;
    }
    h1 { font-size: 20px; border-bottom: 2px solid var(--accent); margin-bottom: 15px; padding-bottom: 10px; }
    .container { max-width: 1280px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }

    /* --- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å›³ --- */
    .topology-panel {
      background: #171923; border: 2px solid #4a5568; border-radius: 12px;
      height: 320px; position: relative; overflow: hidden; padding: 10px;
    }
    .zone {
      position: absolute; top: 10px; bottom: 50px; width: 45%; 
      border-radius: 16px; border: 2px dashed rgba(255,255,255,0.2);
      display: flex; flex-direction: column; align-items: center; padding-top: 5px; pointer-events: none; 
    }
    .zone-net1 { left: 1%; background: rgba(56, 178, 172, 0.05); border-color: var(--net1); }
    .zone-net2 { right: 1%; background: rgba(237, 137, 54, 0.05); border-color: var(--net2); }
    .zone-label { 
      font-weight: bold; font-size: 16px; 
      background: rgba(0,0,0,0.6); padding: 4px 16px; border-radius: 20px; margin-bottom: 2px;
      pointer-events: auto;
    }

    .device {
      width: 120px; text-align: center; position: absolute; cursor: pointer;
      transition: all 0.2s; z-index: 10; padding: 5px; border-radius: 8px;
      transform: translate(-50%, -50%); border: 2px solid transparent;
    }
    .device:hover { transform: translate(-50%, -50%) scale(1.05); background: rgba(255,255,255,0.1); }
    .device.selected { border-color: var(--selected); background: rgba(246, 224, 94, 0.1); box-shadow: 0 0 15px rgba(246, 224, 94, 0.3); z-index: 20; }
    
    .device.selected::after {
      content: "â–¼ é¸æŠä¸­"; 
      position: absolute; top: -30px; left: 50%; transform: translateX(-50%); 
      background: var(--selected); color: #1a202c;
      font-size: 11px; font-weight: bold; padding: 4px 10px; border-radius: 12px;
      white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,0.3); pointer-events: none;
      animation: floatBadge 1s infinite alternate ease-in-out;
    }
    @keyframes floatBadge { from { transform: translateX(-50%) translateY(0); } to { transform: translateX(-50%) translateY(-3px); } }

    .device.error { border-color: var(--error); background: rgba(252, 129, 129, 0.15); animation: pulse-error 2s infinite; }
    @keyframes pulse-error { 0% { box-shadow: 0 0 0 0 rgba(252, 129, 129, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(252, 129, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(252, 129, 129, 0); } }

    .device-icon { font-size: 40px; display: block; margin-bottom: 2px; }
    .device-name { font-size: 11px; font-weight: bold; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 4px; display:inline-block; white-space: nowrap;}
    .device-ip { 
      font-size: 11px; color: #fff; margin-top: 4px; display: inline-block; background: #000; 
      border-radius: 4px; padding: 2px 6px; font-family: monospace; border: 1px solid #444;
      white-space: nowrap; width: auto;
    }

    .d-router { left: 50%; top: 50%; width: 80px; cursor: default;}
    .d-pc11 { left: 15%; top: 30%; } .d-pc12 { left: 15%; top: 70%; } 
    .d-pc21 { left: 85%; top: 30%; } .d-pc22 { left: 85%; top: 70%; }

    .cables { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
    line { stroke: #4a5568; stroke-width: 3; }

    .action-bar { position: absolute; bottom: 10px; width: 100%; display: flex; justify-content: center; gap: 40px; pointer-events: none; z-index: 20; }
    button.action-btn {
      pointer-events: auto; padding: 8px 25px; border: none; border-radius: 30px; 
      font-size: 13px; font-weight: bold; cursor: pointer; color: #1a202c; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: 0.1s;
    }
    .btn-net1 { background: var(--net1); }
    .btn-net2 { background: var(--net2); }

    /* é‡è¤‡è­¦å‘Šè¡¨ç¤º */
    .conflict-warning {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(197, 48, 48, 0.95); color: white; padding: 12px 24px; border-radius: 8px;
      font-weight: bold; z-index: 100; display: none; border: 2px solid #fff;
      box-shadow: 0 0 20px rgba(0,0,0,0.7); pointer-events: none; text-align: center; min-width: 320px;
    }
    .conflict-warning.active { display: block; animation: shake 0.5s infinite; }
    @keyframes shake {
      0% { transform: translate(-50%, -50%) translateX(0); }
      25% { transform: translate(-50%, -50%) translateX(5px); }
      50% { transform: translate(-50%, -50%) translateX(0); }
      75% { transform: translate(-50%, -50%) translateX(-5px); }
      100% { transform: translate(-50%, -50%) translateX(0); }
    }

    /* --- ä¸‹éƒ¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
    .bottom-panel { display: grid; grid-template-columns: 240px 1fr; gap: 15px; }
    .config-box { background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid #4a5568; display: flex; flex-direction: column; gap: 12px; }
    
    .analysis-stack { display: flex; flex-direction: column; gap: 10px; overflow: hidden; }
    .analysis-box { 
      background: var(--panel); padding: 12px; border-radius: 12px; border: 1px solid #4a5568;
      display: flex; flex-direction: column;
    }

    input[type="text"] { width: 100%; padding: 8px; background: #171923; border: 1px solid #555; color: #fff; font-family: monospace; border-radius: 6px; box-sizing: border-box;}
    .range-wrap { display: flex; align-items: center; gap: 10px; }

    /* è­¦å‘Šã‚¨ãƒªã‚¢ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .warning-area, .success-area, .broadcast-warning-area, .nw-warning-area { 
      padding: 10px; display: none; margin-top: 5px; border-radius: 6px; 
    }
    .warning-area.active, .success-area.active, .broadcast-warning-area.active, .nw-warning-area.active { 
      display: block; 
    }
    
    .warning-area { background: var(--warn-bg); border: 2px solid var(--error); }
    .broadcast-warning-area { background: #744210; border: 2px solid var(--broadcast-orange); }
    .nw-warning-area { background: #4a2040; border: 2px solid var(--highlight); }
    .success-area { background: #22543d; border: 2px solid #48bb78; }

    .bit-scroll-area { overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%; margin-top: 5px; }
    .bit-row, .decimal-row { display: flex; align-items: center; margin-bottom: 2px; width: 840px; flex-shrink: 0; }
    .bit-label, .decimal-placeholder { 
      width: 140px; font-size: 11px; font-weight: bold; color: #a0aec0; text-align: right; 
      padding-right: 15px; flex-shrink: 0; white-space: nowrap;
    }
    .bit {
      width: 20px; height: 24px; display: flex; align-items: center; justify-content: center;
      font-family: monospace; font-size: 12px; font-weight:bold; background: #1a202c; color: #555;
      border-radius: 2px; flex-shrink: 0; margin-right: 1px; border: 1px solid transparent;
    }
    .bit.sep { width: 10px; background: transparent; color: #666; border: none; }
    
    .bit.ip-on { background: var(--ip-bg-on); color: #fff; border-bottom: 3px solid var(--ip-color); }
    .bit.ip-off { background: #1a202c; color: #555; border-bottom: 3px solid #718096; }
    .bit.mask-on { background: #555; color: #aaa; }
    .bit.nw-on { background: var(--highlight); color: #fff; }
    .bit.nw-off { background: #1a202c; color: #555; border: 1px dashed var(--highlight); opacity: 0.6; }
    .bit.bc-net-on { background: var(--broadcast-orange); color: #fff; } 
    .bit.bc-net-off { background: #1a202c; color: #555; border: 1px dashed var(--broadcast-orange); opacity: 0.6; }
    .bit.bc-host-on { background: var(--broadcast-yellow); color: #1a202c; box-shadow: 0 0 5px var(--broadcast-yellow); }

    .bit.interactive { cursor: pointer; border: 1px solid #666; }
    .bit.error-bit { background: var(--error-bg) !important; color: #faf089 !important; animation: blink 1s infinite alternate; }

    .decimal-group { width: 167px; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
    .decimal-val { font-family: monospace; font-size: 16px; font-weight: bold; }
    .decimal-dot { width: 11px; text-align: center; color: #666; font-family: monospace; }
    
    .decimal-val.ip { color: var(--ip-color); }
    .decimal-val.nw { color: var(--highlight); }
    .decimal-val.bc { color: var(--broadcast-yellow); }

    .msg-toast {
      position: fixed; bottom: 20px; right: 20px; background: #2d3748; border-left: 4px solid var(--accent);
      color: #fff; padding: 15px 25px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      transform: translateY(100px); transition: 0.3s; z-index: 100;
    }
    .msg-toast.show { transform: translateY(0); }
    .msg-toast.error { border-left-color: var(--error); }

    .packet {
      position: absolute; width: 14px; height: 14px; border-radius: 50%;
      background: #fff; box-shadow: 0 0 10px #fff; z-index: 20; opacity: 0; pointer-events: none; transform: translate(-50%, -50%);
    }
    .packet.broadcast { background: var(--broadcast-yellow); box-shadow: 0 0 10px var(--broadcast-yellow); }
  </style>
</head>
<body>

<div class="container">
  <h1><span>ğŸ› ï¸ IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä»•çµ„ã¿</span></h1>

  <div class="topology-panel" id="topology">
    <svg class="cables">
      <line x1="15%" y1="96" x2="30%" y2="160" /> 
      <line x1="15%" y1="224" x2="30%" y2="160" /> 
      <line x1="30%" y1="160" x2="50%" y2="160" /> 
      <line x1="85%" y1="96" x2="70%" y2="160" /> 
      <line x1="85%" y1="224" x2="70%" y2="160" /> 
      <line x1="70%" y1="160" x2="50%" y2="160" />
    </svg>

    <div class="zone zone-net1"><div class="zone-label" style="color:var(--net1)">NET 1</div></div>
    <div class="zone zone-net2"><div class="zone-label" style="color:var(--net2)">NET 2</div></div>

    <div id="conflict-msg" class="conflict-warning">
      âš ï¸ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹é‡è¤‡ã‚¨ãƒ©ãƒ¼<br>
      <span style="font-size: 11px; font-weight: normal;">NET1 ã¨ NET2 ãŒåŒã˜NWç¯„å›²ã«ãªã£ã¦ã„ã¾ã™ã€‚<br>ãƒ«ãƒ¼ã‚¿ãƒ¼ã«ã‚ˆã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒä¸å¯èƒ½ã§ã™ï¼</span>
    </div>

    <div class="device d-router" id="dev-router"><span class="device-icon">ğŸ§­</span><span class="device-name">Router</span></div>
    
    <div class="device d-pc11" id="dev-pc11" onclick="selectPC('pc11')"><span class="device-icon">ğŸ’»</span><span class="device-name">PC 11</span><span class="device-ip" id="lbl-pc11">...</span></div>
    <div class="device d-pc12" id="dev-pc12" onclick="selectPC('pc12')"><span class="device-icon">ğŸ–¨ï¸</span><span class="device-name">PC 12</span><span class="device-ip" id="lbl-pc12">...</span></div>
    
    <div class="device d-pc21" id="dev-pc21" onclick="selectPC('pc21')"><span class="device-icon">ğŸ»</span><span class="device-name">ãã¾PC</span><span class="device-ip" id="lbl-pc21">...</span></div>
    <div class="device d-pc22" id="dev-pc22" onclick="selectPC('pc22')"><span class="device-icon">ğŸ“±</span><span class="device-name">PC 22</span><span class="device-ip" id="lbl-pc22">...</span></div>

    <div class="action-bar">
      <button class="action-btn btn-net1" onclick="startBroadcast('net1')">ğŸ“¡ NET1 ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ</button>
      <button class="action-btn btn-net2" onclick="startBroadcast('net2')">ğŸ“¡ NET2 ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ</button>
    </div>
  </div>

  <div class="bottom-panel">
    <div class="config-box">
      <h2 style="font-size:15px; margin:0; border-left:4px solid var(--accent); padding-left:10px; color:#fff;">âš™ï¸ è¨­å®š: <span id="target-name">-</span></h2>
      <div>
        <label>IPã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="text" id="cfg-ip" value="" oninput="updateConfigIP()">
      </div>
      <div>
        <label>ã‚µãƒ–ãƒãƒƒãƒˆãƒã‚¹ã‚¯</label>
        <div class="range-wrap">
          <input type="range" id="cfg-cidr" min="8" max="30" value="24" oninput="updateConfigCIDR()">
          <span style="font-family:monospace; font-weight:bold;" id="disp-cidr">/24</span>
        </div>
      </div>
      
      <div id="bc-warning-area" class="broadcast-warning-area">
        <div style="color:var(--broadcast-yellow); font-weight:bold; font-size:12px;">âš ï¸ ç„¡åŠ¹ãªãƒ›ã‚¹ãƒˆIP</div>
        <div style="font-size:11px; color:#ffebee; margin:5px 0;">
          ã“ã®IPã¯<strong>ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹</strong>ã§ã™ã€‚<br>ç«¯æœ«ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
        </div>
      </div>

      <div id="nw-warning-area" class="nw-warning-area">
        <div style="color:var(--highlight); font-weight:bold; font-size:12px;">âš ï¸ ç„¡åŠ¹ãªãƒ›ã‚¹ãƒˆIP</div>
        <div style="font-size:11px; color:#ffebee; margin:5px 0;">
          ã“ã®IPã¯<strong>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹</strong>ã§ã™ã€‚<br>ç«¯æœ«ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
        </div>
      </div>

      <div id="warning-area" class="warning-area">
        <div style="color:#fc8181; font-weight:bold; font-size:12px;">âš ï¸ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸æ•´åˆ</div>
        <div style="font-size:11px; color:#ffd7d7; margin:5px 0;">éš£ã® <span id="peer-name"></span> ã¨NWã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚</div>
        <button class="fix-btn" onclick="fixNetwork()">ğŸ› ï¸ ä¿®æ­£ã™ã‚‹</button>
      </div>
      <div id="success-area" class="success-area">
        <div style="color:#68d391; font-weight:bold; font-size:12px;">âœ… æ•´åˆæ€§OK</div>
      </div>
    </div>

    <div class="analysis-stack">
      <div class="analysis-box">
        <h2 style="font-size:14px; margin:0; border-left:4px solid var(--accent); padding-left:10px; color:#fff;">ğŸ”¬ NWã‚¢ãƒ‰ãƒ¬ã‚¹è§£æ</h2>
        <div class="bit-scroll-area">
          <div id="bit-area-nw"></div>
        </div>
      </div>

      <div class="analysis-box" id="bc-analysis-box" style="display:none;">
        <h2 style="font-size:14px; margin:0; border-left:4px solid var(--broadcast-yellow); padding-left:10px; color:var(--broadcast-yellow);">ğŸ“¡ ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆè§£æ</h2>
        <div class="bit-scroll-area">
          <div id="bit-area-bc"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="msg-toast"></div>

<script>
  // CIDRã‚’ã™ã¹ã¦24ã«åˆæœŸåŒ–
  const DEVICES = {
    'pc11': { ip: '192.168.10.7', cidr: 24, name: 'PC 11', zone: 'net1' },
    'pc12': { ip: '192.168.10.20', cidr: 24, name: 'PC 12', zone: 'net1' },
    'pc21': { ip: '192.168.15.147', cidr: 24, name: 'ãã¾PC', zone: 'net2' },
    'pc22': { ip: '192.168.15.190', cidr: 24, name: 'PC 22', zone: 'net2' }
  };
  let currentId = 'pc11';
  let activeBroadcastNet = null;

  const POS = {
    'pc11':{x:'15%',y:96}, 'pc12':{x:'15%',y:224},
    'hub1':{x:'30%',y:160}, 'router':{x:'50%',y:160},
    'hub2':{x:'70%',y:160},
    'pc21':{x:'85%',y:96}, 'pc22':{x:'85%',y:224}
  };

  function parseIP(str) { return str.split('.').map(Number); }
  function toBin(octs) { return octs.map(o => o.toString(2).padStart(8,'0')).join('').split('').map(Number); }
  function toIp(bits) {
    let res=[]; for(let i=0;i<4;i++) res.push(parseInt(bits.slice(i*8,(i+1)*8).join(''),2));
    return res.join('.');
  }
  
  function getCalculatedData(ipStr, cidr) {
    const octs = parseIP(ipStr);
    const ipBits = toBin(octs);
    const maskBits = Array(32).fill(0).map((_,i)=>i<cidr?1:0);
    const netBits = ipBits.map((b,i)=>b&maskBits[i]);
    const bcBits = ipBits.map((b,i)=> i < cidr ? (b & maskBits[i]) : 1);
    const getOcts = (bits) => {
      let res=[]; for(let i=0;i<4;i++) res.push(parseInt(bits.slice(i*8,(i+1)*8).join(''),2));
      return res;
    };
    return {
      ipOcts: octs, ipBits: ipBits, maskBits: maskBits,
      netBits: netBits, netOcts: getOcts(netBits), netIp: toIp(netBits),
      bcBits: bcBits, bcOcts: getOcts(bcBits), bcIp: toIp(bcBits)
    };
  }

  function getPeerId(id) {
    const zone = DEVICES[id].zone;
    for(let key in DEVICES) if(DEVICES[key].zone === zone && key !== id) return key;
    return null;
  }

  window.onload = () => { updateAllLabels(); selectPC('pc11'); };

  function updateAllLabels() {
    let netAddresses = {};
    let allIps = {};
    let duplicateIps = new Set();

    // 1. IPã®å®Œå…¨é‡è¤‡ãƒã‚§ãƒƒã‚¯
    for(let id in DEVICES) {
        let ip = DEVICES[id].ip;
        if(allIps[ip]) {
            duplicateIps.add(ip);
        }
        allIps[ip] = true;
    }

    // 2. ã‚¾ãƒ¼ãƒ³ã”ã¨ã®ãƒŸã‚¹ãƒãƒƒãƒã¨å…¨ä½“ã®è¡¨ç¤ºæ›´æ–°
    ['net1', 'net2'].forEach(z => {
      const ids = Object.keys(DEVICES).filter(k => DEVICES[k].zone === z);
      const c1 = getCalculatedData(DEVICES[ids[0]].ip, DEVICES[ids[0]].cidr);
      const c2 = getCalculatedData(DEVICES[ids[1]].ip, DEVICES[ids[1]].cidr);
      const isMismatch = c1.netIp !== c2.netIp;
      
      netAddresses[z] = c1.netIp;

      ids.forEach(id => {
        const el = document.getElementById('dev-'+id);
        const hasIpDuplicate = duplicateIps.has(DEVICES[id].ip);
        
        document.getElementById('lbl-'+id).innerText = `${DEVICES[id].ip} /${DEVICES[id].cidr}`;
        
        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸æ•´åˆã‹ã€IPã‚¢ãƒ‰ãƒ¬ã‚¹è‡ªä½“ãŒé‡è¤‡ã—ã¦ã„ã‚‹å ´åˆã«èµ¤æ ã«ã™ã‚‹
        el.classList.toggle('error', isMismatch || hasIpDuplicate);
      });
    });

    if (duplicateIps.size > 0) {
        showToast(`âš ï¸ IPã‚¢ãƒ‰ãƒ¬ã‚¹ [${Array.from(duplicateIps).join(', ')}] ãŒé‡è¤‡ã—ã¦ã„ã¾ã™ï¼`, true);
    }

    // NET1ã¨NET2ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
    const conflictMsg = document.getElementById('conflict-msg');
    const isConflict = (netAddresses['net1'] === netAddresses['net2']);
    
    if (isConflict) {
      conflictMsg.classList.add('active');
      document.getElementById('dev-router').style.filter = 'drop-shadow(0 0 10px var(--error))';
    } else {
      conflictMsg.classList.remove('active');
      document.getElementById('dev-router').style.filter = 'none';
    }
  }

  function selectPC(id) {
    currentId = id; activeBroadcastNet = null;
    const data = DEVICES[id];
    document.querySelectorAll('.device').forEach(d => d.classList.remove('selected'));
    document.getElementById('dev-'+id).classList.add('selected');
    document.getElementById('target-name').innerText = data.name;
    document.getElementById('cfg-ip').value = data.ip;
    document.getElementById('cfg-cidr').value = data.cidr;
    document.getElementById('disp-cidr').innerText = '/' + data.cidr;
    refreshAnalysis();
  }

  function updateConfigIP() {
    const ipStr = document.getElementById('cfg-ip').value;
    if(ipStr.split('.').length === 4) { DEVICES[currentId].ip = ipStr; updateAllLabels(); refreshAnalysis(); }
  }

  function updateConfigCIDR() {
    const cidr = parseInt(document.getElementById('cfg-cidr').value);
    document.getElementById('disp-cidr').innerText = '/' + cidr;
    for(let id in DEVICES) DEVICES[id].cidr = cidr;
    updateAllLabels(); refreshAnalysis();
  }

  function toggleIpBit(index) {
    const bits = toBin(parseIP(DEVICES[currentId].ip));
    bits[index] = bits[index] === 1 ? 0 : 1; 
    const newIp = toIp(bits);
    DEVICES[currentId].ip = newIp;
    document.getElementById('cfg-ip').value = newIp;
    updateAllLabels(); refreshAnalysis();
  }

  function refreshAnalysis() {
    const d = DEVICES[currentId];
    const calc = getCalculatedData(d.ip, d.cidr);
    const peer = DEVICES[getPeerId(currentId)];
    const peerCalc = getCalculatedData(peer.ip, peer.cidr);
    const isMismatch = (calc.netIp !== peerCalc.netIp);

    const isBroadcastMatch = (d.ip === calc.bcIp);
    const isNetworkMatch = (d.ip === calc.netIp);

    const bcWarnArea = document.getElementById('bc-warning-area');
    const nwWarnArea = document.getElementById('nw-warning-area');
    const ipInput = document.getElementById('cfg-ip');

    bcWarnArea.classList.remove('active');
    nwWarnArea.classList.remove('active');
    ipInput.style.color = '#fff';
    ipInput.style.borderColor = '#555';

    if (isBroadcastMatch) {
      bcWarnArea.classList.add('active');
      ipInput.style.color = 'var(--broadcast-yellow)';
      ipInput.style.borderColor = 'var(--broadcast-yellow)';
    } else if (isNetworkMatch) {
      nwWarnArea.classList.add('active');
      ipInput.style.color = 'var(--highlight)';
      ipInput.style.borderColor = 'var(--highlight)';
    }

    document.getElementById('warning-area').classList.toggle('active', isMismatch);
    document.getElementById('success-area').classList.toggle('active', !isMismatch && !isBroadcastMatch && !isNetworkMatch);
    if(isMismatch) document.getElementById('peer-name').innerText = peer.name;

    const nwArea = document.getElementById('bit-area-nw');
    nwArea.innerHTML = '';
    const pNetBits = toBin(parseIP(peerCalc.netIp));
    nwArea.appendChild(createDecimalRow(calc.ipOcts, 'ip'));
    nwArea.appendChild(createBitRow('IPã‚¢ãƒ‰ãƒ¬ã‚¹', calc.ipBits, 'ip', d.cidr, pNetBits));
    nwArea.appendChild(createBitRow('ã‚µãƒ–ãƒãƒƒãƒˆãƒã‚¹ã‚¯', calc.maskBits, 'mask', d.cidr));
    nwArea.appendChild(createBitRow('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹', calc.netBits, 'net', d.cidr, pNetBits));
    nwArea.appendChild(createDecimalRow(calc.netOcts, 'nw'));

    const bcBox = document.getElementById('bc-analysis-box');
    const bcArea = document.getElementById('bit-area-bc');
    if (!activeBroadcastNet || document.getElementById('dev-'+currentId).classList.contains('error')) {
      bcBox.style.display = 'none';
    } else {
      bcBox.style.display = 'block';
      bcArea.innerHTML = '';
      bcArea.appendChild(createBitRow('ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹', calc.bcBits, 'bc', d.cidr));
      bcArea.appendChild(createDecimalRow(calc.bcOcts, 'bc'));
    }
  }

  function createBitRow(label, bits, type, cidr, peerNetBits = []) {
    const row = document.createElement('div'); row.className = 'bit-row';
    const lbl = document.createElement('div'); lbl.className = 'bit-label'; lbl.innerText = label;
    row.appendChild(lbl);
    bits.forEach((b, i) => {
      if(i > 0 && i % 8 === 0) {
        const sep = document.createElement('div'); sep.className='bit sep'; sep.innerText='.'; row.appendChild(sep);
      }
      const bit = document.createElement('div');
      let cls = 'bit';
      if(type === 'ip') {
        cls += ' interactive ' + (b===1 ? 'ip-on' : 'ip-off');
        if(i < cidr && peerNetBits.length && b !== peerNetBits[i]) cls += ' error-bit';
        bit.onclick = () => toggleIpBit(i);
      } else if (type === 'mask') { if(b===1) cls += ' mask-on'; 
      } else if (type === 'net') {
        if(i < cidr) {
          cls += (b===1 ? ' nw-on' : ' nw-off');
          if(peerNetBits.length && b !== peerNetBits[i]) { cls += ' error-bit interactive'; bit.onclick = () => toggleIpBit(i); }
        }
      } else if (type === 'bc') {
        if(i < cidr) cls += (b===1 ? ' bc-net-on' : ' bc-net-off');
        else cls += (b===1 ? ' bc-host-on' : ' bc-host-off');
      }
      bit.className = cls; bit.innerText = b; row.appendChild(bit);
    });
    return row;
  }

  function createDecimalRow(octs, type) {
    const row = document.createElement('div'); row.className = 'decimal-row';
    const ph = document.createElement('div'); ph.className = 'decimal-placeholder'; row.appendChild(ph);
    octs.forEach((oct, i) => {
      if(i > 0) { const dot = document.createElement('div'); dot.className = 'decimal-dot'; dot.innerText = '.'; row.appendChild(dot); }
      const group = document.createElement('div'); group.className = 'decimal-group';
      const val = document.createElement('div'); val.className = 'decimal-val ' + type; val.innerText = oct;
      group.appendChild(val); row.appendChild(group);
    });
    return row;
  }

  function startBroadcast(net) {
    const d = DEVICES[currentId];
    if(d.zone !== net) { showToast(`âš ï¸ ${d.name} ã¯ ${net.toUpperCase()} ã®æ‰€å±ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`, true); return; }
    if(document.getElementById('dev-'+currentId).classList.contains('error')) { showToast("ğŸš« è¨­å®šä¸æ•´åˆã¾ãŸã¯IPé‡è¤‡ã®ãŸã‚é€ä¿¡ã§ãã¾ã›ã‚“", true); return; }
    
    const net1C = getCalculatedData(DEVICES['pc11'].ip, DEVICES['pc11'].cidr);
    const net2C = getCalculatedData(DEVICES['pc21'].ip, DEVICES['pc21'].cidr);
    if(net1C.netIp === net2C.netIp) showToast("âš ï¸ NWã‚¢ãƒ‰ãƒ¬ã‚¹é‡è¤‡ã«ã‚ˆã‚Šãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒä¸å¯èƒ½ã§ã™", true);

    activeBroadcastNet = net; refreshAnalysis();
    showToast(`ğŸ“¡ ${d.name} ã‹ã‚‰ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé€å‡ºä¸­...`);
    const hubId = (net==='net1') ? 'hub1' : 'hub2';
    const peerId = getPeerId(currentId);
    const p1 = document.createElement('div'); p1.className='packet broadcast';
    document.getElementById('topology').appendChild(p1);
    anim(p1, currentId, hubId, () => {
      p1.remove();
      const targets = [peerId, 'router'];
      targets.forEach(targetId => {
        const pSub = document.createElement('div'); pSub.className='packet broadcast';
        document.getElementById('topology').appendChild(pSub);
        anim(pSub, hubId, targetId, () => {
          if(targetId === peerId) {
            if(document.getElementById('dev-'+peerId).classList.contains('error')) {
              showToast("âš ï¸ å®›å…ˆå´ã®è¨­å®šã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šç„¡è¦–ã•ã‚Œã¾ã—ãŸ", true); pSub.style.background = "var(--error)";
            } else { showToast("âœ… åŒä¸€NWå†…ã®å…¨ç«¯æœ«ã¸åˆ°é”ï¼", false, true); }
          }
          setTimeout(() => pSub.remove(), 500);
        });
      });
    });
  }

  function fixNetwork() {
    const d = DEVICES[currentId];
    const peer = DEVICES[getPeerId(currentId)];
    const peerCalc = getCalculatedData(peer.ip, peer.cidr);
    const peerNetBits = toBin(parseIP(peerCalc.netIp));
    const currentBits = toBin(parseIP(d.ip));
    const newBits = currentBits.map((b, i) => i < d.cidr ? peerNetBits[i] : b);
    DEVICES[currentId].ip = toIp(newBits);
    document.getElementById('cfg-ip').value = DEVICES[currentId].ip;
    updateAllLabels(); refreshAnalysis(); 
    showToast(`âœ… ${peer.name} ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«åŒæœŸã—ã¾ã—ãŸ`, false, true);
  }

  function getPx(k){
    const el = document.getElementById('topology');
    const w = el.offsetWidth;
    let val = POS[k];
    let x = val.x; if(typeof x === 'string') x = parseFloat(x)/100 * w;
    return {x:x, y:val.y};
  }

  function anim(el,s,e,cb){
    const sp=getPx(s); const ep=getPx(e);
    el.style.left = sp.x + 'px'; el.style.top = sp.y + 'px';
    el.style.opacity = 1; el.style.transition = 'all 0.6s linear';
    requestAnimationFrame(()=>{
      requestAnimationFrame(()=>{
        const dx = ep.x - sp.x; const dy = ep.y - sp.y;
        el.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
      });
    });
    setTimeout(()=>{ if(cb)cb(); }, 600);
  }

  function showToast(msg, isError, isSuccess) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.className = 'msg-toast show';
    if(isError) t.classList.add('error'); if(isSuccess) t.classList.add('success');
    setTimeout(()=>t.classList.remove('show'), 3000);
  }
</script>
</body>
</html>
