<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IPãƒ“ãƒƒãƒˆæ“ä½œãƒ©ãƒœ (é…è‰²æ”¹å–„ç‰ˆ)</title>
  <style>
    :root {
      --bg: #1a202c;
      --panel: #2d3748;
      --text: #e2e8f0;
      
      /* --- è‰²å®šç¾©ã®èª¿æ•´ --- */
      --accent: #63b3ed;
      --selected: #f6e05e;
      --error: #fc8181;
      --error-bg: #c53030;
      --warn-bg: #742a2a;
      
      /* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒªã‚¢ã®è‰² */
      --net1: #38b2ac; /* å°‘ã—ç·‘å¯„ã‚Šã®ãƒ†ã‚£ãƒ¼ãƒ«ã«å¤‰æ›´ */
      --net2: #ed8936; /* ã‚ªãƒ¬ãƒ³ã‚¸ */
      
      /* å½¹å‰²åˆ¥ã®è‰² */
      --mask: #a0aec0;       /* ãƒã‚¹ã‚¯ã¯ã‚°ãƒ¬ãƒ¼ç³»ã§æ§ãˆã‚ã« */
      --highlight: #d53f8c;  /* NWã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆè¨ˆç®—çµæœï¼‰ã¯ãƒ”ãƒ³ã‚¯ */
      
      /* â˜…å¤‰æ›´: IPã‚¢ãƒ‰ãƒ¬ã‚¹ç”¨ã®è‰² (æ˜ã‚‹ã„ãƒ‘ãƒ¼ãƒ—ãƒ«) */
      --ip-color: #d6bcfa;   
      --ip-bg-on: #805ad5;   /* ãƒ“ãƒƒãƒˆONæ™‚ã®èƒŒæ™¯è‰² (æ¿ƒã„ç´«) */
      
      --success: #48bb78;
    }
    body {
      margin: 0; font-family: "Helvetica Neue", Arial, sans-serif;
      background: var(--bg); color: var(--text); padding: 20px;
    }
    h1 { font-size: 20px; border-bottom: 2px solid var(--accent); margin-bottom: 15px; padding-bottom: 10px; }

    .container { max-width: 1280px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }

    /* --- 1. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å›³ --- */
    .topology-panel {
      background: #171923; border: 2px solid #4a5568; border-radius: 12px;
      height: 320px; position: relative; overflow: hidden; padding: 10px;
    }

    .zone {
      position: absolute; top: 10px; bottom: 50px; width: 45%; 
      border-radius: 16px; border: 2px dashed rgba(255,255,255,0.2);
      display: flex; flex-direction: column; align-items: center; padding-top: 5px; pointer-events: none; 
    }
    .zone-net1 { left: 1%; background: rgba(56, 178, 172, 0.05); border-color: var(--net1); }
    .zone-net2 { right: 1%; background: rgba(237, 137, 54, 0.05); border-color: var(--net2); }
    
    .zone-label { 
      font-weight: bold; font-size: 16px; 
      background: rgba(0,0,0,0.6); padding: 4px 16px; border-radius: 20px; margin-bottom: 2px;
      pointer-events: auto;
    }
    
    .device {
      width: 110px; text-align: center; position: absolute; cursor: pointer;
      transition: all 0.2s; z-index: 10; padding: 5px; border-radius: 8px;
      transform: translate(-50%, -50%); border: 2px solid transparent;
    }
    .device:hover { transform: translate(-50%, -50%) scale(1.05); background: rgba(255,255,255,0.1); }
    
    .device.selected { 
      border-color: var(--selected); background: rgba(246, 224, 94, 0.15);
      box-shadow: 0 0 15px rgba(246, 224, 94, 0.4); z-index: 20; 
    }
    .device.selected::after {
      content: "â–¼ é¸æŠä¸­"; position: absolute; top: -28px; left: 50%;
      transform: translateX(-50%); background: var(--selected); color: #1a202c;
      font-size: 11px; font-weight: bold; padding: 3px 8px; border-radius: 12px;
      white-space: nowrap; pointer-events: none; animation: floatBadge 1s infinite alternate ease-in-out;
    }
    @keyframes floatBadge { from { transform: translateX(-50%) translateY(0); } to { transform: translateX(-50%) translateY(-4px); } }

    .device.error {
      border-color: var(--error); background: rgba(252, 129, 129, 0.15);
      box-shadow: 0 0 0 2px var(--error); animation: pulse-error 2s infinite; z-index: 15;
    }
    .device.ok { border-color: var(--success); background: rgba(72, 187, 120, 0.1); }

    @keyframes pulse-error {
      0% { box-shadow: 0 0 0 0px rgba(252, 129, 129, 0.7); }
      70% { box-shadow: 0 0 0 8px rgba(252, 129, 129, 0); }
      100% { box-shadow: 0 0 0 0px rgba(252, 129, 129, 0); }
    }
    
    .device-icon { font-size: 40px; display: block; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); margin-bottom: 2px; }
    .device-name { font-size: 11px; font-weight: bold; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 4px; display:inline-block;}
    .device-ip { 
      font-size: 11px; color: #fff; margin-top: 4px; display: block; 
      background: #000; border-radius: 4px; padding: 2px 6px;
      font-family: monospace; white-space: nowrap; border: 1px solid #444;
    }

    .d-router { left: 50%; top: 50%; width: 80px; cursor: default;}
    .d-pc11 { left: 15%; top: 30%; } .d-pc12 { left: 15%; top: 70%; } 
    .d-pc21 { left: 85%; top: 30%; } .d-pc22 { left: 85%; top: 70%; }

    .cables { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
    line { stroke: #4a5568; stroke-width: 3; }

    .action-bar { 
      position: absolute; bottom: 10px; width: 100%; 
      display: flex; justify-content: center; gap: 40px; pointer-events: none; z-index: 20;
    }
    button.action-btn {
      pointer-events: auto; padding: 8px 25px; border: none; border-radius: 30px; 
      font-size: 13px; font-weight: bold; cursor: pointer; color: #1a202c; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: transform 0.1s;
      display: flex; align-items: center; gap: 5px;
    }
    button.action-btn:active { transform: scale(0.95); }
    .btn-net1 { background: var(--net1); }
    .btn-net2 { background: var(--net2); }

    /* --- 2. ä¸‹éƒ¨ãƒ‘ãƒãƒ« --- */
    .bottom-panel { 
      display: grid; 
      grid-template-columns: 220px 1fr; 
      gap: 15px; 
    }
    .config-box { background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid #4a5568; display: flex; flex-direction: column; gap: 12px; }
    .analysis-box { 
      background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid #4a5568; 
      display: flex; flex-direction: column; overflow: hidden; 
    }

    input[type="text"] { width: 100%; padding: 8px; background: #171923; border: 1px solid #555; color: #fff; font-family: monospace; font-size: 14px; border-radius: 6px; box-sizing: border-box; }
    .range-wrap { display: flex; align-items: center; gap: 10px; }
    input[type="range"] { flex: 1; cursor: pointer; }

    .warning-area {
      background: var(--warn-bg); border: 2px solid var(--error); border-radius: 6px;
      padding: 10px; display: none; margin-top: 5px; animation: fadeIn 0.3s;
    }
    .warning-area.active { display: block; }
    
    .success-area {
      background: #22543d; border: 2px solid #48bb78; border-radius: 6px;
      padding: 10px; display: none; margin-top: 5px; animation: fadeIn 0.3s;
    }
    .success-area.active { display: block; }

    button.fix-btn {
      margin-top: 8px; width: 100%; padding: 8px; background: #fff; color: #c53030;
      border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s;
    }

    /* --- ãƒ“ãƒƒãƒˆè¡¨ç¤º (è‰²èª¿æ•´æ¸ˆã¿) --- */
    .bit-container { overflow-x: auto; padding-bottom: 5px; margin-top: 5px; }
    .bit-row { display: flex; align-items: center; margin-bottom: 3px; }
    .bit-label { width: 110px; font-size: 11px; font-weight: bold; color: #a0aec0; text-align: right; padding-right: 10px; flex-shrink: 0; }
    
    .bit {
      width: 20px; height: 24px; display: flex; align-items: center; justify-content: center;
      font-family: monospace; font-size: 12px; font-weight:bold; background: #1a202c; color: #555;
      border-radius: 2px; flex-shrink: 0; margin-right: 1px; border: 1px solid transparent; user-select: none;
    }
    .bit.sep { width: 10px; background: transparent; color: #666; border: none; }

    /* â˜… IPã‚¢ãƒ‰ãƒ¬ã‚¹ (ãƒ‘ãƒ¼ãƒ—ãƒ«ç³») */
    .bit.ip-on { 
      background: var(--ip-bg-on); 
      color: #fff; 
      border-bottom: 3px solid var(--ip-color); 
    }
    .bit.ip-off { 
      background: #1a202c; 
      color: #555; 
      border-bottom: 3px solid #718096; /* ãƒ›ã‚¹ãƒˆéƒ¨OFFã¯ã‚°ãƒ¬ãƒ¼ */
    }
    
    .bit.mask-on { background: #555; color: #aaa; }
    
    /* â˜… NWã‚¢ãƒ‰ãƒ¬ã‚¹ (ãƒ”ãƒ³ã‚¯ç³») */
    .bit.nw-on { background: var(--highlight); color: #fff; }
    .bit.nw-off { background: #1a202c; color: #555; border: 1px dashed var(--highlight); opacity: 0.6; }
    
    .bit.interactive { cursor: pointer; border: 1px solid #666; }
    .bit.interactive:hover { border-color: #fff; transform: translateY(-1px); }

    .bit.error-bit { 
      background: var(--error-bg) !important; color: #faf089 !important;
      border: 1px solid var(--error) !important; animation: blink 1s infinite alternate;
    }
    @keyframes blink { from{opacity:0.8;} to{opacity:1;} }

    /* 10é€²æ•°è¡Œå…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .decimal-row { display: flex; align-items: center; margin-bottom: 5px; }
    .decimal-val { 
      width: 168px; text-align: center; flex-shrink: 0; 
      font-family: monospace; font-size: 16px; font-weight: bold; 
    }
    .decimal-sep { width: 10px; text-align: center; flex-shrink: 0; color: #666; }
    .decimal-placeholder { width: 110px; flex-shrink: 0; }

    /* â˜… IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®10é€²æ•°æ–‡å­—è‰² */
    .decimal-val.ip { 
      color: var(--ip-color); 
      text-shadow: 0 0 10px rgba(214, 188, 250, 0.3); 
    }
    
    /* â˜… NWã‚¢ãƒ‰ãƒ¬ã‚¹ã®10é€²æ•°æ–‡å­—è‰² */
    .decimal-val.nw { 
      color: var(--highlight); 
    }

    .msg-toast {
      position: fixed; bottom: 20px; right: 20px; background: #2d3748; border-left: 4px solid var(--accent);
      color: #fff; padding: 15px 25px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      transform: translateY(100px); transition: transform 0.3s; z-index: 100;
    }
    .msg-toast.show { transform: translateY(0); }
    .msg-toast.error { border-left-color: var(--error); }
    .msg-toast.success { border-left-color: #48bb78; background: #22543d; }

    .packet {
      position: absolute; width: 14px; height: 14px; border-radius: 50%;
      background: #fff; box-shadow: 0 0 10px #fff; z-index: 20; opacity: 0; pointer-events: none; transform: translate(-50%, -50%);
    }
    .packet.broadcast { background: var(--mask); box-shadow: 0 0 10px var(--mask); }

    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
    @media (max-width: 800px) { .bottom-panel { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<div class="container">
  <h1><span>ğŸ› ï¸ IPãƒ“ãƒƒãƒˆæ“ä½œãƒ©ãƒœ</span></h1>

  <div class="topology-panel" id="topology">
    <svg class="cables">
      <line x1="15%" y1="96" x2="30%" y2="160" /> 
      <line x1="15%" y1="224" x2="30%" y2="160" /> 
      <line x1="30%" y1="160" x2="50%" y2="160" /> 
      <line x1="85%" y1="96" x2="70%" y2="160" /> 
      <line x1="85%" y1="224" x2="70%" y2="160" /> 
      <line x1="70%" y1="160" x2="50%" y2="160" />
    </svg>

    <div class="zone zone-net1"><div class="zone-label" style="color:var(--net1)">NET 1</div></div>
    <div class="zone zone-net2"><div class="zone-label" style="color:var(--net2)">NET 2</div></div>

    <div class="device d-router"><span class="device-icon">ğŸ§­</span><span class="device-name">Router</span></div>
    
    <div class="device d-pc11" id="dev-pc11" onclick="selectPC('pc11')"><span class="device-icon">ğŸ’»</span><span class="device-name">PC 11</span><span class="device-ip" id="lbl-pc11">...</span></div>
    <div class="device d-pc12" id="dev-pc12" onclick="selectPC('pc12')"><span class="device-icon">ğŸ–¨ï¸</span><span class="device-name">PC 12</span><span class="device-ip" id="lbl-pc12">...</span></div>
    
    <div class="device d-pc21" id="dev-pc21" onclick="selectPC('pc21')"><span class="device-icon">ğŸ»</span><span class="device-name">ãã¾PC</span><span class="device-ip" id="lbl-pc21">...</span></div>
    <div class="device d-pc22" id="dev-pc22" onclick="selectPC('pc22')"><span class="device-icon">ğŸ“±</span><span class="device-name">PC 22</span><span class="device-ip" id="lbl-pc22">...</span></div>

    <div class="action-bar">
      <button class="action-btn btn-net1" onclick="startBroadcast('net1')">ğŸ“¡ NET1 ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ</button>
      <button class="action-btn btn-net2" onclick="startBroadcast('net2')">ğŸ“¡ NET2 ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ</button>
    </div>
  </div>

  <div class="bottom-panel">
    <div class="config-box">
      <h2 style="font-size:15px; margin:0; border-left:4px solid var(--accent); padding-left:10px; color:#fff;">âš™ï¸ è¨­å®š: <span id="target-name">-</span></h2>
      <div>
        <label>IPã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="text" id="cfg-ip" value="" oninput="updateConfigIP()">
      </div>
      <div>
        <label>ã‚µãƒ–ãƒãƒƒãƒˆãƒã‚¹ã‚¯ (å…¨ä½“åŒæœŸ)</label>
        <div class="range-wrap">
          <input type="range" id="cfg-cidr" min="8" max="30" value="24" oninput="updateConfigCIDR()">
          <span style="font-family:monospace; font-weight:bold;" id="disp-cidr">/24</span>
        </div>
      </div>
      
      <div id="warning-area" class="warning-area">
        <div style="color:#fc8181; font-weight:bold; font-size:12px;">âš ï¸ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸æ•´åˆ</div>
        <div style="font-size:11px; color:#ffd7d7; margin:5px 0;">
          éš£ã® <span id="peer-name"></span> ã¨NWã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚
        </div>
        <button class="fix-btn" onclick="fixNetwork()">ğŸ› ï¸ ä¿®æ­£ã™ã‚‹</button>
      </div>
      <div id="success-area" class="success-area">
        <div style="color:#68d391; font-weight:bold; font-size:12px;">âœ… æ•´åˆæ€§OK</div>
      </div>
    </div>

    <div class="analysis-box">
      <h2 style="font-size:15px; margin:0; border-left:4px solid var(--accent); padding-left:10px; color:#fff;">
        ğŸ”¬ ãƒ“ãƒƒãƒˆè§£æ (æ¯”è¼ƒä¸­)
      </h2>
      <div id="bit-area" class="bit-container"></div>
    </div>
  </div>
</div>

<div id="toast" class="msg-toast"></div>

<script>
  /* === ãƒ‡ãƒ¼ã‚¿ === */
  const DEVICES = {
    'pc11': { ip: '192.168.10.7', cidr: 24, name: 'PC 11', zone: 'net1' },
    'pc12': { ip: '192.168.10.20', cidr: 24, name: 'PC 12', zone: 'net1' },
    'pc21': { ip: '192.168.15.147', cidr: 26, name: 'ãã¾PC', zone: 'net2' },
    'pc22': { ip: '192.168.15.190', cidr: 26, name: 'PC 22', zone: 'net2' }
  };
  let currentId = 'pc11';
  const POS = {
    'pc11':{x:'15%',y:96}, 'pc12':{x:'15%',y:224},
    'hub1':{x:'30%',y:160}, 'router':{x:'50%',y:160},
    'hub2':{x:'70%',y:160},
    'pc21':{x:'85%',y:96}, 'pc22':{x:'85%',y:224}
  };

  function parseIP(str) { return str.split('.').map(Number); }
  function toBin(octs) { return octs.map(o => o.toString(2).padStart(8,'0')).join('').split('').map(Number); }
  function toIp(bits) {
    let res=[]; for(let i=0;i<4;i++) res.push(parseInt(bits.slice(i*8,(i+1)*8).join(''),2));
    return res.join('.');
  }
  
  function getCalculatedData(ipStr, cidr) {
    const octs = parseIP(ipStr);
    const ipBits = toBin(octs);
    const maskBits = Array(32).fill(0).map((_,i)=>i<cidr?1:0);
    const netBits = ipBits.map((b,i)=>b&maskBits[i]);
    const netOcts = []; for(let i=0;i<4;i++) netOcts.push(parseInt(netBits.slice(i*8,(i+1)*8).join(''),2));
    return {
      ipOcts: octs,
      maskIp: toIp(maskBits), netIp: toIp(netBits), netOcts: netOcts,
      ipBits: ipBits, maskBits: maskBits, netBits: netBits
    };
  }

  function getPeerId(id) {
    const zone = DEVICES[id].zone;
    for(let key in DEVICES) if(DEVICES[key].zone === zone && key !== id) return key;
    return null;
  }

  window.onload = () => { updateAllLabels(); selectPC('pc11'); };

  function updateAllLabels() {
    const zones = ['net1', 'net2'];
    zones.forEach(z => {
      const ids = Object.keys(DEVICES).filter(k => DEVICES[k].zone === z);
      const d1 = DEVICES[ids[0]], d2 = DEVICES[ids[1]];
      const c1 = getCalculatedData(d1.ip, d1.cidr), c2 = getCalculatedData(d2.ip, d2.cidr);
      const isMismatch = c1.netIp !== c2.netIp;
      ids.forEach(id => {
        const el = document.getElementById('dev-'+id);
        const label = document.getElementById('lbl-'+id);
        label.innerText = `${DEVICES[id].ip} /${DEVICES[id].cidr}`;
        el.classList.remove('error', 'ok');
        if (isMismatch) el.classList.add('error'); else el.classList.add('ok');
      });
    });
  }

  function selectPC(id) {
    currentId = id;
    const data = DEVICES[id];
    document.querySelectorAll('.device').forEach(d => d.classList.remove('selected'));
    document.getElementById('dev-'+id).classList.add('selected');
    document.getElementById('target-name').innerText = data.name;
    document.getElementById('cfg-ip').value = data.ip;
    document.getElementById('cfg-cidr').value = data.cidr;
    document.getElementById('disp-cidr').innerText = '/' + data.cidr;
    refreshAnalysis();
  }

  function updateConfigIP() {
    const ipStr = document.getElementById('cfg-ip').value;
    if(ipStr.split('.').length === 4) {
      DEVICES[currentId].ip = ipStr;
      updateAllLabels(); refreshAnalysis();
    }
  }

  function updateConfigCIDR() {
    const cidr = parseInt(document.getElementById('cfg-cidr').value);
    document.getElementById('disp-cidr').innerText = '/' + cidr;
    for(let id in DEVICES) DEVICES[id].cidr = cidr;
    updateAllLabels(); refreshAnalysis();
  }

  function toggleIpBit(index) {
    const d = DEVICES[currentId];
    const bits = toBin(parseIP(d.ip));
    bits[index] = bits[index] === 1 ? 0 : 1; 
    const newIp = toIp(bits);
    DEVICES[currentId].ip = newIp;
    document.getElementById('cfg-ip').value = newIp;
    updateAllLabels(); refreshAnalysis();
  }

  function refreshAnalysis() {
    const d = DEVICES[currentId];
    const calc = getCalculatedData(d.ip, d.cidr);
    const peerId = getPeerId(currentId);
    const peer = DEVICES[peerId];
    const peerCalc = getCalculatedData(peer.ip, peer.cidr);

    const warnEl = document.getElementById('warning-area');
    const successEl = document.getElementById('success-area');
    const isMismatch = (calc.netIp !== peerCalc.netIp);

    if (isMismatch) {
      warnEl.classList.add('active');
      successEl.classList.remove('active');
      document.getElementById('peer-name').innerText = peer.name;
    } else {
      warnEl.classList.remove('active');
      successEl.classList.add('active');
    }
    renderBits(calc, d.cidr, peerCalc.netIp);
  }

  function renderBits(calc, cidr, peerNetIp) {
    const area = document.getElementById('bit-area');
    area.innerHTML = '';
    const peerNetBits = toBin(parseIP(peerNetIp));

    // --- â˜… IPã‚¢ãƒ‰ãƒ¬ã‚¹ 10é€²æ•°è¡Œ ---
    const ipDecRow = document.createElement('div'); ipDecRow.className = 'decimal-row';
    const ipPh = document.createElement('div'); ipPh.className = 'decimal-placeholder'; ipDecRow.appendChild(ipPh);
    calc.ipOcts.forEach((oct, i) => {
      if(i > 0) { const dot = document.createElement('div'); dot.className = 'decimal-sep'; dot.innerText = '.'; ipDecRow.appendChild(dot); }
      const val = document.createElement('div'); val.className = 'decimal-val ip'; val.innerText = oct; ipDecRow.appendChild(val);
    });
    area.appendChild(ipDecRow);

    const createRow = (label, bits, type) => {
      const row = document.createElement('div'); row.className = 'bit-row';
      const lbl = document.createElement('div'); lbl.className = 'bit-label'; lbl.innerText = label;
      row.appendChild(lbl);

      bits.forEach((b, i) => {
        if(i > 0 && i % 8 === 0) {
          const sep = document.createElement('div'); sep.className='bit sep'; sep.innerText='.'; row.appendChild(sep);
        }
        const bit = document.createElement('div');
        let cls = 'bit';
        if(type === 'ip') {
          cls += ' interactive';
          if(b===1) cls += ' ip-on'; else cls += ' ip-off';
          if(i < cidr) {
             cls += ' ip-net';
             if(b !== peerNetBits[i]) cls += ' error-bit';
          } else { cls += ' ip-host'; }
          bit.onclick = () => toggleIpBit(i);
        } else if (type === 'mask') {
          if(b===1) cls += ' mask-on'; 
        } else if (type === 'net') {
          if(i < cidr) {
            if(b===1) cls += ' nw-on'; else cls += ' nw-off';
            if(b !== peerNetBits[i]) {
              cls += ' error-bit interactive'; bit.onclick = () => toggleIpBit(i); 
            }
          }
        }
        bit.className = cls; bit.innerText = b; row.appendChild(bit);
      });
      area.appendChild(row);
    };

    createRow('IPã‚¢ãƒ‰ãƒ¬ã‚¹', calc.ipBits, 'ip');
    createRow('ã‚µãƒ–ãƒãƒƒãƒˆãƒã‚¹ã‚¯', calc.maskBits, 'mask');
    createRow('NWã‚¢ãƒ‰ãƒ¬ã‚¹(2é€²)', calc.netBits, 'net');

    // --- NWã‚¢ãƒ‰ãƒ¬ã‚¹ 10é€²æ•°è¡Œ ---
    const decRow = document.createElement('div'); decRow.className = 'decimal-row';
    const ph = document.createElement('div'); ph.className = 'decimal-placeholder'; decRow.appendChild(ph);
    calc.netOcts.forEach((oct, i) => {
      if(i > 0) { const dot = document.createElement('div'); dot.className = 'decimal-sep'; dot.innerText = '.'; decRow.appendChild(dot); }
      const val = document.createElement('div'); val.className = 'decimal-val nw'; val.innerText = oct; decRow.appendChild(val);
    });
    area.appendChild(decRow);
  }

  function fixNetwork() {
    const d = DEVICES[currentId];
    const peerId = getPeerId(currentId);
    const peer = DEVICES[peerId];
    const peerCalc = getCalculatedData(peer.ip, peer.cidr);
    const peerNetBits = toBin(parseIP(peerCalc.netIp));
    const currentBits = toBin(parseIP(d.ip));
    
    const newBits = currentBits.map((b, i) => i < d.cidr ? peerNetBits[i] : b);
    const newIp = toIp(newBits);
    
    DEVICES[currentId].ip = newIp;
    document.getElementById('cfg-ip').value = newIp;
    
    updateAllLabels(); refreshAnalysis(); 
    showToast(`âœ… ${peer.name} ã®NWã‚¢ãƒ‰ãƒ¬ã‚¹ã«åˆã‚ã›ã¾ã—ãŸ`, false, true);
  }

  function getPx(k){
    const el = document.getElementById('topology');
    const w = el.offsetWidth;
    let val = POS[k];
    let x = val.x; if(typeof x === 'string') x = parseFloat(x)/100 * w;
    return {x:x, y:val.y};
  }

  function anim(el,s,e,cb){
    const sp=getPx(s); const ep=getPx(e);
    el.style.left = sp.x + 'px'; el.style.top = sp.y + 'px';
    el.style.opacity = 1; el.style.transition = 'all 0.6s linear';
    requestAnimationFrame(()=>{
      const dx = ep.x - sp.x; const dy = ep.y - sp.y;
      el.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    });
    setTimeout(()=>{ if(cb)cb(); else el.remove(); }, 600);
  }

  function showToast(msg, isError, isSuccess) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.className = 'msg-toast';
    if(isError) t.classList.add('error'); if(isSuccess) t.classList.add('success');
    t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000);
  }

  function startBroadcast(net) {
    const d = DEVICES[currentId];
    if(d.zone !== net) {
      showToast(`âš ï¸ ${d.name} ã¯ ${net.toUpperCase()} ã«å±ã—ã¦ã„ã¾ã›ã‚“ã€‚`, true); return;
    }
    if(document.getElementById('dev-'+currentId).classList.contains('error')) {
      showToast("ğŸš« è¨­å®šä¸æ•´åˆã§é€šä¿¡ä¸èƒ½ï¼", true); return;
    }

    showToast(`ğŸ“¡ ${d.name} ã‹ã‚‰ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ`);
    const senderId = currentId;
    const hub = (net==='net1') ? 'hub1' : 'hub2';
    const peerId = getPeerId(currentId);
    
    const p = document.createElement('div'); p.className='packet broadcast';
    document.getElementById('topology').appendChild(p);
    
    anim(p, senderId, hub, ()=>{
      p.remove();
      const p1 = document.createElement('div'); p1.className='packet broadcast';
      document.getElementById('topology').appendChild(p1);
      const p2 = document.createElement('div'); p2.className='packet broadcast';
      document.getElementById('topology').appendChild(p2);
      
      anim(p1, hub, peerId, ()=>{
        const recEl = document.getElementById('dev-'+peerId);
        if(recEl.classList.contains('error')) {
          showToast("âš ï¸ ç›¸æ‰‹ã®è¨­å®šãƒŸã‚¹ã§ä¸é”", true); p1.style.backgroundColor='#fc8181';
        } else { showToast("âœ… å…¨ç«¯æœ«ã«åˆ°é”", false, true); }
        setTimeout(()=>p1.remove(),200);
      });
      anim(p2, hub, 'router', ()=>{
        p2.style.transition='all 0.2s'; p2.style.transform += ' scale(2)'; p2.style.opacity=0;
        setTimeout(()=>p2.remove(),200);
      });
    });
  }
</script>
</body>
</html>
